import React, { useEffect, useMemo, useState } from "react";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip as ReTooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid, Legend } from "recharts";

// MfgCalc — OEE Calculator (Overall Equipment Effectiveness)
// A calculated approach to manufacturing.

// --- Utility helpers ---
function toNumber(v: string | number, fallback = 0): number {
  const n = typeof v === "number" ? v : parseFloat(v || "");
  return isFinite(n) ? n : fallback;
}

function clamp01(x: number) {
  return Math.max(0, Math.min(1, x));
}

function pct(x: number, decimals = 1) {
  return `${(clamp01(x) * 100).toFixed(decimals)}%`;
}

function statusColorOEE(oee: number) {
  if (oee >= 0.8) return "bg-green-100 text-green-800 border-green-300";
  if (oee >= 0.6) return "bg-amber-100 text-amber-800 border-amber-300";
  return "bg-rose-100 text-rose-800 border-rose-300";
}

function downloadCSV(filename: string, rows: Record<string, string | number>[]) {
  const headers = Object.keys(rows[0] || {});
  const csv = [headers.join(",")]
    .concat(
      rows.map((r) => headers.map((h) => `${r[h] != null ? r[h] : ""}`).join(","))
    )
    .join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function serializeStateToQuery(params: Record<string, any>) {
  const usp = new URLSearchParams();
  Object.entries(params).forEach(([k, v]) => {
    if (v !== undefined && v !== null && v !== "") usp.set(k, String(v));
  });
  const url = `${location.pathname}?${usp.toString()}`;
  history.replaceState(null, "", url);
}

function parseQuery(): Record<string, string> {
  const out: Record<string, string> = {};
  const usp = new URLSearchParams(location.search);
  usp.forEach((v, k) => (out[k] = v));
  return out;
}

export default function OEECalculator() {
  // --- Inputs (Basic Mode) ---
  const [shiftMin, setShiftMin] = useState<number>(480);
  const [plannedStopsMin, setPlannedStopsMin] = useState<number>(40);
  const [unplannedMin, setUnplannedMin] = useState<number>(50);

  const [rateMode, setRateMode] = useState<"ict" | "irr">("ict");
  const [ictSec, setIctSec] = useState<number>(30); // Ideal Cycle Time (sec/unit)
  const [irrUph, setIrrUph] = useState<number>(0); // Ideal Run Rate (units/hour)

  const [totalCount, setTotalCount] = useState<number>(700);
  const [goodCount, setGoodCount] = useState<number>(686);

  const [errors, setErrors] = useState<string[]>([]);

  // Load from query on mount
  useEffect(() => {
    const q = parseQuery();
    if (Object.keys(q).length) {
      if (q.shiftMin) setShiftMin(toNumber(q.shiftMin, 480));
      if (q.plannedStopsMin) setPlannedStopsMin(toNumber(q.plannedStopsMin, 0));
      if (q.unplannedMin) setUnplannedMin(toNumber(q.unplannedMin, 0));
      if (q.rateMode === "irr" || q.rateMode === "ict") setRateMode(q.rateMode as any);
      if (q.ictSec) setIctSec(toNumber(q.ictSec, 0));
      if (q.irrUph) setIrrUph(toNumber(q.irrUph, 0));
      if (q.totalCount) setTotalCount(toNumber(q.totalCount, 0));
      if (q.goodCount) setGoodCount(toNumber(q.goodCount, 0));
    }
  }, []);

  // Derived values
  const { ppt, rt, availability, performance, quality, oee, warnings, scrapUnits, perfIdealTimeMin, availabilityLossMin, performanceLossMin, qualityLossMin } = useMemo(() => {
    const errs: string[] = [];

    const _ppt = Math.max(0, shiftMin - plannedStopsMin);
    const _rt = Math.max(0, _ppt - unplannedMin);

    if (_ppt <= 0) errs.push("Planned production time must be greater than zero.");
    if (goodCount > totalCount) errs.push("Good units cannot exceed total units.");

    let perf = 0;
    let perfIdealMin = 0;

    if (_rt <= 0) {
      // no runtime → availability=0, performance suppressed
      perf = 0;
    } else {
      if (rateMode === "ict") {
        const ictMin = ictSec > 0 ? ictSec / 60 : 0;
        perfIdealMin = ictMin * totalCount;
        perf = ictMin > 0 && totalCount > 0 ? perfIdealMin / _rt : 0;
      } else {
        const actualRate = totalCount / (_rt / 60);
        perf = irrUph > 0 && totalCount > 0 ? actualRate / irrUph : 0;
        // For loss visualization using IRR, estimate ideal time from IRR as baseline
        perfIdealMin = irrUph > 0 ? (totalCount / irrUph) * 60 : 0;
      }
    }

    const avail = _ppt > 0 ? _rt / _ppt : 0;
    const qual = totalCount > 0 && goodCount >= 0 && goodCount <= totalCount ? goodCount / totalCount : 0;

    // OEE
    const _oee = clamp01(avail * perf * qual);

    // Warnings
    const warns: string[] = [];
    if (_rt <= 0) warns.push("No runtime recorded; performance cannot be computed.");
    if (rateMode === "ict" && ictSec > 0 && totalCount > 0 && perfIdealMin > _rt * 1.1) {
      warns.push("Ideal cycle × count exceeds runtime by >10% — check ICT or counts.");
    }

    // Loss approximations for visualization (minutes)
    const availabilityLoss = Math.max(0, _ppt - _rt);
    const performanceLoss = Math.max(0, _rt - perfIdealMin);
    const qualityLoss = rateMode === "ict" && ictSec > 0 ? ((totalCount - goodCount) * (ictSec / 60)) : 0; // convert scrap to time

    return {
      ppt: _ppt,
      rt: _rt,
      availability: clamp01(avail),
      performance: clamp01(perf),
      quality: clamp01(qual),
      oee: _oee,
      warnings: warns,
      scrapUnits: Math.max(0, totalCount - goodCount),
      perfIdealTimeMin: perfIdealMin,
      availabilityLossMin: availabilityLoss,
      performanceLossMin: performanceLoss,
      qualityLossMin: Math.max(0, qualityLoss),
    };
  }, [shiftMin, plannedStopsMin, unplannedMin, rateMode, ictSec, irrUph, totalCount, goodCount]);

  // Validate and set errors
  useEffect(() => {
    const e: string[] = [];
    if (ppt <= 0) e.push("Planned production time must be greater than zero.");
    if (goodCount > totalCount) e.push("Good units cannot exceed total units.");
    setErrors(e);
  }, [ppt, totalCount, goodCount]);

  const lossData = useMemo(() => {
    return [
      { name: "Availability Loss", minutes: availabilityLossMin },
      { name: "Performance Loss", minutes: performanceLossMin },
      { name: "Quality Loss", minutes: qualityLossMin },
    ];
  }, [availabilityLossMin, performanceLossMin, qualityLossMin]);

  const donutData = useMemo(() => {
    return [
      { name: "OEE", value: oee },
      { name: "Loss", value: clamp01(1 - oee) },
    ];
  }, [oee]);

  // Share/permalink
  const handleShare = () => {
    serializeStateToQuery({
      shiftMin,
      plannedStopsMin,
      unplannedMin,
      rateMode,
      ictSec,
      irrUph,
      totalCount,
      goodCount,
    });
    navigator.clipboard?.writeText(window.location.href);
  };

  const handleExportCSV = () => {
    const rows = [
      {
        timestamp: new Date().toISOString(),
        url: window.location.href,
        shift_minutes: shiftMin,
        planned_stops_minutes: plannedStopsMin,
        unplanned_downtime_minutes: unplannedMin,
        rate_mode: rateMode,
        ideal_cycle_time_sec: ictSec,
        ideal_run_rate_uph: irrUph,
        total_count: totalCount,
        good_count: goodCount,
        scrap_units: scrapUnits,
        ppt_minutes: ppt,
        run_time_minutes: rt,
        availability: (availability * 100).toFixed(1),
        performance: (performance * 100).toFixed(1),
        quality: (quality * 100).toFixed(1),
        oee: (oee * 100).toFixed(1),
        availability_loss_min: availabilityLossMin,
        performance_loss_min: performanceLossMin,
        quality_loss_min: qualityLossMin,
      },
    ];
    downloadCSV("mfgcalc_oee.csv", rows as any);
  };

  return (
    <div className="w-full mx-auto max-w-6xl p-4 md:p-6 lg:p-8">
      <header className="mb-6 md:mb-8">
        <h1 className="text-2xl md:text-3xl font-bold">OEE Calculator (Overall Equipment Effectiveness)</h1>
        <p className="text-sm text-neutral-600">Compute Availability, Performance, and Quality — and see loss breakdowns. <span className="font-semibold">MfgCalc</span> · <em>A calculated approach to manufacturing.</em></p>
      </header>

      {/* Inputs & Results layout */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Inputs Panel */}
        <section className="bg-white border rounded-2xl p-4 md:p-6 shadow-sm">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold">Inputs</h2>
            <div className="flex items-center gap-2">
              <span className={`px-2 py-1 rounded-full text-xs border ${rateMode === "ict" ? "bg-neutral-900 text-white border-neutral-900" : "bg-neutral-100"}`}>
                ICT
              </span>
              <button
                className="text-xs underline"
                onClick={() => setRateMode(rateMode === "ict" ? "irr" : "ict")}
              >
                Toggle to {rateMode === "ict" ? "IRR (units/hr)" : "ICT (sec/unit)"}
              </button>
            </div>
          </div>

          <div className="space-y-4">
            {/* Time */}
            <div>
              <h3 className="font-medium mb-2">Time</h3>
              <div className="grid grid-cols-2 gap-3">
                <label className="text-sm">Shift length (min)
                  <input type="number" min={0} value={shiftMin} onChange={(e) => setShiftMin(toNumber(e.target.value))} className="mt-1 w-full border rounded-lg px-3 py-2" />
                </label>
                <label className="text-sm">Planned stops (min)
                  <input type="number" min={0} value={plannedStopsMin} onChange={(e) => setPlannedStopsMin(toNumber(e.target.value))} className="mt-1 w-full border rounded-lg px-3 py-2" />
                </label>
                <label className="text-sm col-span-2">Unplanned downtime (min)
                  <input type="number" min={0} value={unplannedMin} onChange={(e) => setUnplannedMin(toNumber(e.target.value))} className="mt-1 w-full border rounded-lg px-3 py-2" />
                </label>
              </div>
            </div>

            {/* Rate */}
            <div>
              <h3 className="font-medium mb-2">Rate</h3>
              {rateMode === "ict" ? (
                <label className="text-sm">Ideal cycle time (sec/unit)
                  <input type="number" min={0} value={ictSec} onChange={(e) => setIctSec(toNumber(e.target.value))} className="mt-1 w-full border rounded-lg px-3 py-2" />
                </label>
              ) : (
                <label className="text-sm">Ideal run rate (units/hour)
                  <input type="number" min={0} value={irrUph} onChange={(e) => setIrrUph(toNumber(e.target.value))} className="mt-1 w-full border rounded-lg px-3 py-2" />
                </label>
              )}
            </div>

            {/* Counts */}
            <div>
              <h3 className="font-medium mb-2">Counts</h3>
              <div className="grid grid-cols-2 gap-3">
                <label className="text-sm">Total units
                  <input type="number" min={0} value={totalCount} onChange={(e) => setTotalCount(toNumber(e.target.value))} className="mt-1 w-full border rounded-lg px-3 py-2" />
                </label>
                <label className="text-sm">Good units
                  <input type="number" min={0} value={goodCount} onChange={(e) => setGoodCount(toNumber(e.target.value))} className="mt-1 w-full border rounded-lg px-3 py-2" />
                </label>
              </div>
              <p className="text-xs text-neutral-500 mt-1">Scrap auto-calculated as Total − Good.</p>
            </div>

            {errors.length > 0 && (
              <div className="border border-rose-300 bg-rose-50 text-rose-800 rounded-lg p-3 text-sm">
                <ul className="list-disc ml-5 space-y-1">
                  {errors.map((er, i) => (
                    <li key={i}>{er}</li>
                  ))}
                </ul>
              </div>
            )}

            <div className="flex flex-wrap gap-2">
              <button onClick={handleExportCSV} disabled={errors.length > 0} className="px-3 py-2 rounded-lg border shadow-sm disabled:opacity-50">Export CSV</button>
              <button onClick={handleShare} className="px-3 py-2 rounded-lg border shadow-sm">Copy shareable link</button>
            </div>
          </div>
        </section>

        {/* Results Panel */}
        <section className="bg-white border rounded-2xl p-4 md:p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">Results</h2>

          {/* KPI cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div className={`border rounded-xl p-3 ${statusColorOEE(oee)}`}>
              <div className="text-xs uppercase tracking-wide">OEE</div>
              <div className="text-2xl font-bold">{pct(oee)}</div>
            </div>
            <div className="border rounded-xl p-3">
              <div className="text-xs uppercase tracking-wide">Availability</div>
              <div className="text-2xl font-bold">{pct(availability)}</div>
            </div>
            <div className="border rounded-xl p-3">
              <div className="text-xs uppercase tracking-wide">Performance</div>
              <div className="text-2xl font-bold">{pct(performance)}</div>
            </div>
            <div className="border rounded-xl p-3">
              <div className="text-xs uppercase tracking-wide">Quality</div>
              <div className="text-2xl font-bold">{pct(quality)}</div>
            </div>
          </div>

          {/* Secondary metrics */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 text-sm">
            <div className="border rounded-xl p-3"><div className="text-neutral-500">Planned Production Time</div><div className="font-semibold">{ppt} min</div></div>
            <div className="border rounded-xl p-3"><div className="text-neutral-500">Run Time</div><div className="font-semibold">{rt} min</div></div>
            <div className="border rounded-xl p-3"><div className="text-neutral-500">Total Count</div><div className="font-semibold">{totalCount}</div></div>
            <div className="border rounded-xl p-3"><div className="text-neutral-500">Good / Scrap</div><div className="font-semibold">{goodCount} / {scrapUnits}</div></div>
          </div>

          {/* Charts */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="h-60">
              <h3 className="font-medium mb-2">OEE</h3>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie data={donutData} dataKey="value" nameKey="name" innerRadius={60} outerRadius={80}>
                    {donutData.map((entry, index) => (
                      <Cell key={`cell-${index}`} />
                    ))}
                  </Pie>
                  <ReTooltip formatter={(v: any) => `${(v * 100).toFixed(1)}%`} />
                </PieChart>
              </ResponsiveContainer>
              <p className="text-xs text-neutral-500 mt-1">World‑class OEE is often cited ≈ 85% (process dependent).</p>
            </div>
            <div className="h-60">
              <h3 className="font-medium mb-2">Loss Breakdown (minutes)</h3>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={lossData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" interval={0} tick={{ fontSize: 12 }} />
                  <YAxis />
                  <Legend />
                  <Bar dataKey="minutes" name="Minutes" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {warnings.length > 0 && (
            <div className="mt-4 border border-amber-300 bg-amber-50 text-amber-900 rounded-lg p-3 text-sm">
              <ul className="list-disc ml-5 space-y-1">
                {warnings.map((w, i) => (
                  <li key={i}>{w}</li>
                ))}
              </ul>
            </div>
          )}

          {/* Benchmarks */}
          <div className="mt-6 text-sm bg-neutral-50 border rounded-xl p-3">
            <div className="font-medium mb-1">Benchmarks (guidance, not targets)</div>
            <ul className="list-disc ml-5 space-y-1 text-neutral-700">
              <li>OEE ≈ <span className="font-semibold">85%</span> is often cited as world‑class.</li>
              <li>Availability ≥ <span className="font-semibold">90%</span>, Performance ≥ <span className="font-semibold">95%</span>, Quality ≥ <span className="font-semibold">99%</span>.</li>
            </ul>
          </div>
        </section>
      </div>

      {/* Help/FAQ */}
      <section className="mt-8 bg-white border rounded-2xl p-4 md:p-6 shadow-sm">
        <h2 className="text-lg font-semibold mb-2">What is OEE?</h2>
        <p className="text-sm text-neutral-700 mb-2">Overall Equipment Effectiveness (OEE) combines <strong>Availability</strong>, <strong>Performance</strong>, and <strong>Quality</strong> to quantify how effectively a manufacturing operation is utilized.</p>
        <ul className="text-sm list-disc ml-5 space-y-1 text-neutral-700">
          <li><strong>Availability</strong> = Run Time ÷ Planned Production Time</li>
          <li><strong>Performance</strong> = (Ideal Cycle Time × Total Count) ÷ Run Time, or Actual Rate ÷ Ideal Run Rate</li>
          <li><strong>Quality</strong> = Good Count ÷ Total Count</li>
        </ul>
      </section>
    </div>
  );
}
